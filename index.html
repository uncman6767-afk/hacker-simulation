<!DOCTYPE html>
<html>
<head>
  <title>Beam.MGDrive Max</title>
  <style>
    body { margin:0; overflow:hidden; font-family:sans-serif; }
    #hud { position:absolute; top:10px; left:10px; color:white; background:rgba(0,0,0,0.5); padding:10px; border-radius:8px;}
    #menu { position:absolute; top:10px; right:10px; color:white; background:rgba(0,0,0,0.7); padding:10px; border-radius:8px;}
    button { margin:5px; padding:5px 10px; }
  </style>
</head>
<body>
<div id="hud">Speed: 0 km/h | Nitro: 100%</div>
<div id="menu">
  <button onclick="selectCar('red')">Red Car</button>
  <button onclick="selectCar('blue')">Blue Car</button>
  <button onclick="selectCar('green')">Green Car</button>
  <button onclick="upgrade('engine')">Engine +</button>
  <button onclick="upgrade('tires')">Tires +</button>
  <button onclick="upgrade('suspension')">Suspension +</button>
</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>

<script>
let scene, camera, renderer, world;
let carBody, carMesh, wheels=[], wheelMeshes=[];
let keys = {};
let speed = 0;
let nitro = 100;
let carStats = {engine:1, tires:1, suspension:1};
let currentCarColor = 'red';

// === Init Scene & Physics ===
function init(){
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0x87ceeb);
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  world = new CANNON.World();
  world.gravity.set(0, -9.82, 0);

  // Ground with hills & ramps
  const groundShape = new CANNON.Plane();
  const groundBody = new CANNON.Body({type:CANNON.Body.STATIC});
  groundBody.addShape(groundShape);
  groundBody.quaternion.setFromEuler(-Math.PI/2,0,0);
  world.addBody(groundBody);

  const groundGeo = new THREE.PlaneGeometry(500,500,50,50);
  const groundMat = new THREE.MeshPhongMaterial({color:0x228B22});
  const groundMesh = new THREE.Mesh(groundGeo,groundMat);
  groundMesh.rotation.x = -Math.PI/2;
  scene.add(groundMesh);

  // Add ramps
  const rampGeo = new THREE.BoxGeometry(10,2,20);
  const rampMat = new THREE.MeshPhongMaterial({color:0x8B4513});
  for(let i=0;i<5;i++){
    const rampMesh = new THREE.Mesh(rampGeo,rampMat);
    rampMesh.position.set(Math.random()*200-100,1,Math.random()*200-100);
    rampMesh.rotation.z = Math.random()*0.3;
    scene.add(rampMesh);
    const rampShape = new CANNON.Box(new CANNON.Vec3(5,1,10));
    const rampBody = new CANNON.Body({mass:0});
    rampBody.addShape(rampShape);
    rampBody.position.copy(rampMesh.position);
    rampBody.quaternion.copy(rampMesh.quaternion);
    world.addBody(rampBody);
  }

  // Lights
  const light = new THREE.DirectionalLight(0xffffff,1);
  light.position.set(30,50,30);
  scene.add(light);
  scene.add(new THREE.AmbientLight(0x404040));

  createCar();
  animate();
}

// === Create Car with Wheels ===
function createCar(){
  if(carMesh) scene.remove(carMesh);
  carBody = new CANNON.Body({mass:1500});
  const boxShape = new CANNON.Box(new CANNON.Vec3(1,0.5,2));
  carBody.addShape(boxShape);
  carBody.position.set(0,5,0);
  world.addBody(carBody);

  carMesh = new THREE.Mesh(new THREE.BoxGeometry(2,1,4),
      new THREE.MeshPhongMaterial({color:currentCarColor}));
  scene.add(carMesh);

  wheels=[]; wheelMeshes=[];
  const wheelPositions = [[1,-0.5,1.5],[-1,-0.5,1.5],[1,-0.5,-1.5],[-1,-0.5,-1.5]];
  wheelPositions.forEach(pos=>{
    const wheel = new CANNON.Body({mass:50, shape:new CANNON.Sphere(0.5)});
    wheel.position.set(carBody.position.x+pos[0], carBody.position.y+pos[1], carBody.position.z+pos[2]);
    world.addBody(wheel);
    wheels.push(wheel);

    const wheelMesh = new THREE.Mesh(new THREE.SphereGeometry(0.5,16,16),
      new THREE.MeshPhongMaterial({color:0x333333}));
    scene.add(wheelMesh);
    wheelMeshes.push(wheelMesh);
  });
}

// === Controls ===
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// === Car Selection & Upgrades ===
function selectCar(color){ currentCarColor=color; createCar(); }
function upgrade(type){
  if(type==='engine') carStats.engine+=0.2;
  if(type==='tires') carStats.tires+=0.2;
  if(type==='suspension') carStats.suspension+=0.2;
}

// === Animate ===
function animate(){
  requestAnimationFrame(animate);

  // Car physics
  const force = 5000 * carStats.engine;
  if(keys['w']) carBody.applyForce(new CANNON.Vec3(0,0,-force), carBody.position);
  if(keys['s']) carBody.applyForce(new CANNON.Vec3(0,0,force), carBody.position);
  if(keys['a']) carBody.quaternion.setFromEuler(0,carBody.quaternion.toEuler().y+0.03,0);
  if(keys['d']) carBody.quaternion.setFromEuler(0,carBody.quaternion.toEuler().y-0.03,0);
  if(keys[' ']){ // Nitro
    if(nitro>0){ carBody.applyForce(new CANNON.Vec3(0,0,-force*2), carBody.position); nitro-=1; }
  } else { if(nitro<100) nitro+=0.2; }

  world.step(1/60);

  carMesh.position.copy(carBody.position);
  carMesh.quaternion.copy(carBody.quaternion);

  wheels.forEach((w,i)=>{
    wheelMeshes[i].position.copy(w.position);
    wheelMeshes[i].quaternion.copy(w.quaternion);
  });

  // Camera follow
  const camOffset = new THREE.Vector3(10,5,10);
  const camPos = carBody.position.clone().vadd(camOffset);
  camera.position.lerp(camPos,0.1);
  camera.lookAt(carBody.position);

  // HUD
  speed = carBody.velocity.length()*3.6; // km/h
  document.getElementById('hud').innerText=`Speed: ${speed.toFixed(1)} km/h | Nitro: ${nitro.toFixed(0)}%`;

  renderer.render(scene,camera);
}

init();
</script>
</body>
</html>
